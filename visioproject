$RegPaths = @(
    "HKLM:\Software\Microsoft\Windows\CurrentVersion\Uninstall\*",
    "HKLM:\Software\Wow6432Node\Microsoft\Windows\CurrentVersion\Uninstall\*"
)

$LogPath = "C:\Program Files\instlogs\PKG"
$LogFile = Join-Path $LogPath "VisioProject_Removal_$(Get-Date -Format 'yyyyMMdd_HHmmss').log"

# Create log directory if it doesn't exist
if (!(Test-Path $LogPath)) {
    New-Item -Path $LogPath -ItemType Directory -Force | Out-Null
}

# Start logging
"=== Visio and Project Removal Log ===" | Out-File $LogFile
"Start Time: $(Get-Date)" | Out-File $LogFile -Append
"" | Out-File $LogFile -Append

# Remove Visio
"Removing Visio installations..." | Out-File $LogFile -Append
$VisioProducts = Get-ItemProperty $RegPaths -ErrorAction SilentlyContinue | Where {$_.DisplayName -like "*Visio*"}
ForEach ($Product in $VisioProducts) {
    $UninstallString = $Product.UninstallString
    "Found: $($Product.DisplayName)" | Out-File $LogFile -Append
    "Uninstall String: $UninstallString" | Out-File $LogFile -Append
    
    if ($UninstallString -match '^"(.+?)"(.*)$') {
        $UninstallEXE = $matches[1]
        $UninstallArg = $matches[2].Trim() + " DisplayLevel=False"
        "Executing: $UninstallEXE $UninstallArg" | Out-File $LogFile -Append
        Start-Process -FilePath $UninstallEXE -ArgumentList $UninstallArg -Wait
    } else {
        "WARNING: Unable to parse uninstall string" | Out-File $LogFile -Append
    }
}

# Remove Project
"" | Out-File $LogFile -Append
"Removing Project installations..." | Out-File $LogFile -Append
$ProjectProducts = Get-ItemProperty $RegPaths -ErrorAction SilentlyContinue | Where {$_.DisplayName -like "*Project*"}
ForEach ($Product in $ProjectProducts) {
    $UninstallString = $Product.UninstallString
    "Found: $($Product.DisplayName)" | Out-File $LogFile -Append
    "Uninstall String: $UninstallString" | Out-File $LogFile -Append
    
    if ($UninstallString -match '^"(.+?)"(.*)$') {
        $UninstallEXE = $matches[1]
        $UninstallArg = $matches[2].Trim() + " DisplayLevel=False"
        "Executing: $UninstallEXE $UninstallArg" | Out-File $LogFile -Append
        Start-Process -FilePath $UninstallEXE -ArgumentList $UninstallArg -Wait
    } else {
        "WARNING: Unable to parse uninstall string" | Out-File $LogFile -Append
    }
}

# End logging
"" | Out-File $LogFile -Append
"End Time: $(Get-Date)" | Out-File $LogFile -Append